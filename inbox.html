<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Inbox | Stick Arc</title>
<link rel="icon" href="favicon.ico.png">

<link rel="stylesheet" href="atp.css">
</head>

<body>

<div class="inbox-container">
  <h2>Inbox</h2>
  <div id="messages">Loading...</div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAIgpVbHc_xdeTb02V_KE13MvxTmWKOSLM",
  authDomain: "stickarc-dcbc9.firebaseapp.com",
  projectId: "stickarc-dcbc9"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

auth.onAuthStateChanged(user => {
  if (!user) { location.href = "login.html"; return; }
  loadInbox(user.uid);
});

async function loadInbox(myUID) {
  const inbox = document.getElementById("messages");
  inbox.innerHTML = "Loading...";

  const snap = await db.collection("messages")
    .where("receiverId", "==", myUID)
    .orderBy("timestamp", "desc")
    .get();

  inbox.innerHTML = "";
  const shownSenders = new Set();

  for (const d of snap.docs) {
    const msg = d.data();
    if (shownSenders.has(msg.senderId)) continue;
    shownSenders.add(msg.senderId);

    const userSnap = await db.collection("users")
      .where("uid", "==", msg.senderId)
      .get();
    if (userSnap.empty) continue;
    const sender = userSnap.docs[0].data();

    const unreadSnap = await db.collection("messages")
      .where("receiverId", "==", myUID)
      .where("senderId", "==", msg.senderId)
      .where("unread", "==", true)
      .get();

    const unreadCount = unreadSnap.size;

    const div = document.createElement("div");
    div.className = "message";

    div.innerHTML = `
      <img src="${sender.photoURL || 'default-avatar.png'}" title="${sender.username}">
      <div class="message-content">
        <strong>${sender.username}</strong>
        <span class="last-text">${msg.text || ""}</span>
      </div>
      ${unreadCount>0?`<span class="badge">${unreadCount}</span>`:""}
    `;

    div.onclick = () => {
      location.href = "message.html?to=" + encodeURIComponent(sender.username);
    };

    inbox.appendChild(div);
  }

  if (!inbox.hasChildNodes()) {
    inbox.innerHTML = "<p style='text-align:center;opacity:.7'>No messages yet</p>";
  }
}
</script>

</body>
</html>
