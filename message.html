<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat | Stick Arc</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>/* ===== RESET ===== */
*{
  margin:0;
  padding:0;
  box-sizing:border-box;
}

body{
  font-family:'Poppins',sans-serif;
  background: radial-gradient(circle at top,#2a1400,#070300 70%);
  color:#ffdca8;
  height:100vh;
  display:flex;
  flex-direction:column;
  overflow:hidden;
}

/* ===== HEADER ===== */
.header{
  display:flex;
  align-items:center;
  gap:12px;
  padding:12px 15px;

  backdrop-filter: blur(14px);
  background: rgba(25,12,0,0.65);

  border-bottom:1px solid rgba(255,180,60,0.2);

  box-shadow:0 0 20px rgba(255,140,0,0.2);
}

.header img{
  width:42px;
  height:42px;
  border-radius:50%;
  object-fit:cover;

  box-shadow:0 0 15px rgba(255,170,0,0.6);
}

#userName{
  font-weight:600;
  font-size:15px;
  flex:1;
  color:#ffcc66;
  text-shadow:0 0 6px rgba(255,170,0,0.7);
}

/* ===== MENU ===== */
.menu-wrapper{
  position:relative;
}

.menu-btn{
  background:none;
  border:none;
  font-size:20px;
  color:#ffd27a;
  cursor:pointer;
}

.menu-dropdown{
  position:absolute;
  top:35px;
  right:0;
  display:none;
  flex-direction:column;
  min-width:160px;

  backdrop-filter: blur(15px);
  background: rgba(30,15,0,0.85);

  border:1px solid rgba(255,180,60,0.25);
  border-radius:12px;
  overflow:hidden;

  box-shadow:0 0 20px rgba(255,140,0,0.3);
}

.menu-item{
  padding:10px 14px;
  cursor:pointer;
  font-size:13px;
}

.menu-item:hover{
  background:rgba(255,140,0,0.15);
}

.menu-item.danger{
  color:#ff7676;
}

/* ===== MESSAGES AREA ===== */
.messages{
  flex:1;
  overflow-y:auto;
  padding:15px;
  display:flex;
  flex-direction:column;
  gap:10px;
}

/* ===== MESSAGE BUBBLES ===== */
.msg{
  max-width:75%;
  padding:10px 14px;
  border-radius:18px;
  position:relative;
  font-size:14px;
  line-height:1.4;
  word-wrap:break-word;
}

/* MY MESSAGE */
.msg.me{
  align-self:flex-end;
  background:linear-gradient(135deg,#ffcc00,#ff6a00);
  color:#000;
  box-shadow:0 0 15px rgba(255,150,40,0.7);
}

/* OTHER MESSAGE */
.msg.other{
  align-self:flex-start;
  background:rgba(40,20,0,0.8);
  backdrop-filter:blur(10px);
  border:1px solid rgba(255,180,60,0.2);
  box-shadow:0 0 12px rgba(255,120,0,0.2);
}

/* ===== TIME ===== */
.time{
  font-size:10px;
  margin-top:4px;
  opacity:0.7;
  text-align:right;
}

/* ===== REACTION ===== */
.reaction{
  position:absolute;
  bottom:-10px;
  right:-5px;
  font-size:14px;
}

/* ===== REPLY BOX INSIDE MESSAGE ===== */
.reply-box{
  font-size:11px;
  padding:6px 8px;
  margin-bottom:5px;
  border-left:3px solid #ffb347;
  background:rgba(255,180,0,0.1);
  border-radius:8px;
}

/* ===== OPTIONS POPUP ===== */
.msg-options{
  position:absolute;
  top:-40px;
  display:flex;
  gap:6px;
  padding:6px;
  border-radius:20px;

  backdrop-filter:blur(15px);
  background:rgba(30,15,0,0.9);
  border:1px solid rgba(255,180,60,0.25);

  box-shadow:0 0 20px rgba(255,140,0,0.3);
}

.msg-options.left{
  left:0;
}

.msg-options.right{
  right:0;
}

.msg-options button{
  border:none;
  background:none;
  color:#ffd27a;
  cursor:pointer;
  font-size:12px;
}

/* ===== REPLY PREVIEW ===== */
.reply-preview{
  display:none;
  padding:8px 12px;
  font-size:12px;
  background:rgba(255,180,0,0.1);
  border-top:1px solid rgba(255,180,60,0.2);
}

.reply-preview button{
  float:right;
  background:none;
  border:none;
  color:#ff6a00;
  cursor:pointer;
}

/* ===== INPUT BOX ===== */
.input-box{
  display:flex;
  padding:10px;
  gap:10px;

  backdrop-filter: blur(14px);
  background: rgba(25,12,0,0.75);

  border-top:1px solid rgba(255,180,60,0.2);
}

.input-box input{
  flex:1;
  padding:10px 14px;
  border-radius:25px;
  border:1px solid rgba(255,180,60,0.3);
  background:#140900;
  color:#ffdca8;
  outline:none;
}

.send{
  width:42px;
  border:none;
  border-radius:50%;
  background:linear-gradient(135deg,#ffcc00,#ff6a00);
  color:#000;
  font-size:16px;
  cursor:pointer;
  box-shadow:0 0 15px rgba(255,140,0,0.8);
}

.send:active{
  transform:scale(0.9);
}

</style>
</head>

<body>

<div class="header">
  <img id="userPic">
  <div id="userName">Loadingâ€¦</div>

  <div class="menu-wrapper">
    <button class="menu-btn" id="menuBtn">â‹®</button>
    <div class="menu-dropdown" id="chatMenu">
      <div class="menu-item danger" id="deleteAll">Delete all messages</div>
    </div>
  </div>
</div>

<div class="messages" id="messages"></div>

<!-- REPLY PREVIEW -->
<div class="reply-preview" id="replyPreview">
  Replying to: <span id="replyText"></span>
  <button onclick="cancelReply()">âœ•</button>
</div>

<div class="input-box">
  <input id="text" placeholder="Messageâ€¦">
  <button class="send" id="sendBtn">âž¤</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, collection, addDoc, query, orderBy,
  onSnapshot, serverTimestamp, updateDoc,
  deleteDoc, doc, getDocs, getDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, onAuthStateChanged }
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const app = initializeApp({
  apiKey:"AIzaSyAIgpVbHc_xdeTb02V_KE13MvxTmWKOSLM",
  authDomain:"stickarc-dcbc9.firebaseapp.com",
  projectId:"stickarc-dcbc9"
});
const db=getFirestore(app);
const auth=getAuth(app);

const otherUsername=new URLSearchParams(location.search).get("to");

const box=document.getElementById("messages");
const input=document.getElementById("text");
const userName=document.getElementById("userName");
const userPic=document.getElementById("userPic");
const menuBtn=document.getElementById("menuBtn");
const chatMenu=document.getElementById("chatMenu");
const replyPreview=document.getElementById("replyPreview");
const replyText=document.getElementById("replyText");

let myUID, otherUID, chatId;
let replyingTo=null;

/* MENU */
menuBtn.onclick=e=>{
  e.stopPropagation();
  chatMenu.style.display=
    chatMenu.style.display==="flex"?"none":"flex";
};
document.body.onclick=()=>chatMenu.style.display="none";

/* AUTH */
onAuthStateChanged(auth,async user=>{
  if(!user) return;
  myUID=user.uid;

  const otherSnap=await getDoc(doc(db,"users",otherUsername));
  const other=otherSnap.data();
  otherUID=other.uid;

  userName.textContent=other.username;
  userPic.src = other.photoURL && other.photoURL.trim() !== ""
  ? other.photoURL
  : "default-avatar.png";


  chatId=[myUID,otherUID].sort().join("_");
  listen();
});

/* LISTEN */
function listen(){
  const q=query(collection(db,"chats",chatId,"messages"),orderBy("createdAt"));

  onSnapshot(q,snap=>{
    box.innerHTML="";
    snap.forEach(d=>{
      const m=d.data();
      if(m.deletedFor?.includes(myUID)) return;

      if(m.receiverId===myUID && !m.seen){
        updateDoc(d.ref,{seen:true});
      }

      const div=document.createElement("div");
      div.className="msg "+(m.senderId===myUID?"me":"other");

      div.innerHTML=`
        ${m.replyTo?`
          <div class="reply-box">${m.replyTo.text}</div>
        `:""}
        ${m.text}
        ${m.reaction?`<span class="reaction">${m.reaction}</span>`:""}
        <div class="time">
          ${m.senderId===myUID?(m.seen?" âœ”âœ”":" âœ”"):""}
        </div>
      `;

      div.onclick=()=>options(div,d.id,m);
      box.appendChild(div);
    });
    box.scrollTop=box.scrollHeight;
  });
}

/* OPTIONS */
function options(div,id,m){
  document.querySelectorAll(".msg-options").forEach(e=>e.remove());

  const o=document.createElement("div");

  // ðŸ”¥ POV LOGIC
  // agar message MY hai â†’ options LEFT
  // agar OTHER ka hai â†’ options RIGHT
  o.className="msg-options " + (m.senderId===myUID ? "left" : "right");

  const reply=document.createElement("button");
  reply.textContent="Reply";
  reply.onclick=()=>{
    replyingTo=m;
    replyText.textContent=m.text;
    replyPreview.style.display="block";
  };

  ["â¤ï¸","ðŸ˜‚","ðŸ‘"].forEach(r=>{
    const b=document.createElement("button");
    b.textContent=r;
    b.onclick=()=>updateDoc(
      doc(db,"chats",chatId,"messages",id),
      {reaction:r}
    );
    o.appendChild(b);
  });

  const delMe=document.createElement("button");
  delMe.textContent="Delete for me";
  delMe.onclick=()=>updateDoc(
    doc(db,"chats",chatId,"messages",id),
    { deletedFor:[...(m.deletedFor||[]),myUID] }
  );

  const delAll=document.createElement("button");
  delAll.textContent="Delete for all";
  delAll.onclick=()=>{
    if(m.senderId!==myUID) return;
    deleteDoc(doc(db,"chats",chatId,"messages",id));
  };

  o.append(reply,delMe,delAll);
  div.appendChild(o);
}


/* CANCEL REPLY */
window.cancelReply=()=>{
  replyingTo=null;
  replyPreview.style.display="none";
};

/* DELETE ALL */
document.getElementById("deleteAll").onclick=async()=>{
  if(!confirm("Delete all messages?"))return;
  const snap=await getDocs(collection(db,"chats",chatId,"messages"));
  snap.forEach(d=>deleteDoc(d.ref));
};

/* SEND */
document.getElementById("sendBtn").onclick=async()=>{
  if(!input.value.trim())return;

  await addDoc(collection(db,"chats",chatId,"messages"),{
    senderId:myUID,
    receiverId:otherUID,
    text:input.value,
    replyTo:replyingTo?{
      text:replyingTo.text,
      senderId:replyingTo.senderId
    }:null,
    createdAt:serverTimestamp(),
    seen:false,
    deletedFor:[]
  });

  input.value="";
  cancelReply();
};
</script>

</body>
</html>
